<?xml version="1.0" encoding="UTF-8"?>

<process key="individual-task" name="Individual task workflow" version="2" xmlns="http://jbpm.org/4.4/jpdl" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jbpm.org/4.4/jpdl jpdl.xsd">
   <description>Workflow to manage individual tasks.</description>
   
   <variable init-expr="TASK_UNREAD" name="TASK_READ_STATUS" type="string"/> 
   
   <start g="685,3,186,52" name="start1">
      <transition g="462,27:" to="isRelation"/>
   </start>
   
   <decision g="439,118,80,40" name="isRelation">
      <transition g="-74,-20" name="no relation" to="isAssignee">
        <condition expr="#{INDI_RELATION_ID==null}"/>
      </transition>
      <transition g="-43,-27" name="relation" to="java.loadAssignee">
        <condition expr="#{INDI_RELATION_ID!=null}"/>
      </transition>
   </decision>
   
   <java class="sernet.verinice.bpm.ProzessExecution" g="507,53,150,36" method="loadAssignee" name="java.loadAssignee" var="ISA_ASSIGNEE_NAME">
      <arg><object expr="#{UUID}"/></arg>
      <arg><object expr="#{INDI_RELATION_ID}"/></arg>      
      <transition to="isAssignee"/>
   </java>  
   
   <decision g="800,119,80,40" name="isAssignee">
      <transition g="694,165;693,271:-93,-36" name="not assigned" to="indi.task.assign">
        <condition expr="#{ISA_ASSIGNEE_NAME==null}"/>
      </transition>
      <transition g="5,-79" name="assigned" to="indi.task.execute">
        <condition expr="#{ISA_ASSIGNEE_NAME!=null}"/>
      </transition>
   </decision>
   
   <task assignee="#{ISA_OWNER_NAME}" duedate="#{ISA_DUEDATE}" g="261,248,146,52" name="indi.task.assign">
      <on event="timeout">
      <timer duedate="#{INDI_REMINDER_DATE}"/>
        <event-listener class="sernet.verinice.bpm.ProcessCreaterReminder">
          <field name="taskType"><string value="indi.task.assign"/></field>
        </event-listener>
      </on>
      <transition g="334,214;236,169:54,36" name="indi.trans.complete" to="checkDate"/>
   </task>
   
   <java class="sernet.verinice.bpm.DateChecker" g="122,123,100,35" method="checkIfDateIsPast" name="checkDate" var="ISA_DUEDATE">
      <arg><object expr="#{ISA_DUEDATE}"/></arg>
      <arg><object expr="7"/></arg>
      <transition to="checkReminderDate"/>
   </java>
   
   <java class="sernet.verinice.bpm.DateChecker" g="253,124,161,35" method="checkIfDateIsPast" name="checkReminderDate" var="INDI_REMINDER_DATE">
      <arg><object expr="#{INDI_REMINDER_DATE}"/></arg>
      <arg><object expr="7"/></arg>
      <transition to="isRelation"/>
   </java>
    
    
   <!-- Execute --> 
    
   <task assignee="#{ISA_ASSIGNEE_NAME}" duedate="#{ISA_DUEDATE}" g="614,317,186,52" name="indi.task.execute">
   <!-- Test settings -->
<!--    <task assignee="#{ISA_ASSIGNEE_NAME}" duedate="3 minutes" g="730,318,186,52" name="indi.task.execute"> -->
      <on event="reminder-timeout">
      <timer duedate="2 minute"/>
         <event-listener class="sernet.verinice.bpm.Reminder">
            <field name="taskType"><string value="indi.task.execute"/></field>
         </event-listener>
      </on>
      <transition g="-253,136" name="indi.trans.complete" to="indi.task.check"/>
      <transition g="171,343:264,-19" name="indi.trans.notResposible" to="indi.task.assign.nr"/> 
      <transition g="-47,-24" name="timeout" to="java.sendReminder.admin">
          <timer duedate="#{ISA_DUEDATE}"/>
          <!-- Test settings -->
<!--           <timer duedate="3 minutes"/> -->
      </transition>
      <transition g="-108,-29" name="indi.trans.extension" to="indi.fork.extension"/>
   </task> 
   
   <fork g="675,391,48,48" name="indi.fork.extension">
      <transition to="indi.task.extension"/>
      <transition g="797,416:" to="indi.task.execute"/>
   </fork>
   
   <task assignee="#{ISA_OWNER_NAME}" duedate="7 days" g="486,432,186,52" name="indi.task.extension">
      <transition g="-89,-7" name="indi.trans.extension.decline" to="extension.end"/>
      <transition g="671,510:-34,14" name="indi.trans.extension.accept" to="extension.end"/>
   </task>
   
   <java class="sernet.verinice.bpm.Reminder" g="399,382,212,34" method="sendEmail" name="java.sendReminder.admin">
      <arg><object expr="#{execution.id}"/></arg>
      <arg><object expr="indi.task.execute.deadline.admin"/></arg>
      <arg><object expr="#{ISA_OWNER_NAME}"/></arg>
      <arg><object expr="#{UUID}"/></arg>
      <transition to="java.sendReminder"/>
   </java>
   
   <task assignee="#{ISA_ASSIGNEE_NAME}" duedate="#{ISA_DUEDATE}" g="241,577,186,52" name="indi.task.execute.loop">
   <!-- Test settings -->
<!--    <task assignee="#{ISA_ASSIGNEE_NAME}" duedate="2 minutes" g="237,577,186,52" name="indi.task.execute.loop"> -->
      <transition g="113,-143" name="indi.trans.complete" to="indi.task.check"/>
      <transition g="173,602:8,-250" name="indi.trans.notResposible" to="indi.task.assign.nr"/> 
      <transition g="260,565;259,435:-58,-9" name="timeout" to="java.sendReminder">
         <timer duedate="#{ISA_DUEDATE}"/>
          <!-- Test settings -->
<!--           <timer duedate="2 minutes"/> -->
      </transition>
      <transition g="-126,-20" name="indi.trans.extension" to="indi.fork.extension.loop"/>
   </task>
   
   <fork g="452,511,48,48" name="indi.fork.extension.loop">
      <transition g="474,589:" to="indi.task.execute.loop"/>
      <transition to="indi.task.extension"/>
   </fork>
   
   <java class="sernet.verinice.bpm.Reminder" g="188,383,170,34" method="sendEmail" name="java.sendReminder">
      <arg><object expr="#{execution.id}"/></arg>
      <arg><object expr="indi.task.execute.deadline.assignee"/></arg>
      <arg><object expr="#{ISA_ASSIGNEE_NAME}"/></arg>
      <arg><object expr="#{UUID}"/></arg>
      <transition to="checkDate.execute"/>
   </java>
   
   <java class="sernet.verinice.bpm.DateChecker" g="275,480,162,40" method="checkIfDateIsPast" name="checkDate.execute" var="ISA_DUEDATE">
      <arg><object expr="#{ISA_DUEDATE}"/></arg>
      <arg><object expr="7"/></arg>
      <transition to="indi.task.execute.loop"/>
   </java>
   
   <task assignee="#{ISA_OWNER_NAME}" duedate="7 days" g="98,245,147,52" name="indi.task.assign.nr">
      <transition g="5,22" name="indi.trans.assigned" to="checkDate"/>
   </task>
     
   
   <!-- Check -->
   
   <task assignee="#{ISA_OWNER_NAME}" duedate="#{ISA_DUEDATE} + 14 days" g="731,572,186,52" name="indi.task.check">
      <transition g="899,462:8,-6" name="indi.trans.decline" to="indi.task.execute"/>
      <transition name="indi.trans.accept" to="end" g="-118,-22"/>
   </task>
   
   <state g="521,528,124,37" name="extension.end"/>
   
   <end g="800,688,48,48" name="end"/>
   
</process>