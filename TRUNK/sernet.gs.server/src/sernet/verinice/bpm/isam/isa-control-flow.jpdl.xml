<?xml version="1.0" encoding="UTF-8"?>

<process key="isa-control-flow" name="verinice ISA control flow" version="1" xmlns="http://jbpm.org/4.4/jpdl" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jbpm.org/4.4/jpdl jpdl.xsd">
   <description>ISA control flow in verinice</description>
   
   
   
   <start g="982,145,186,52" name="start1">
      <transition to="isAssignee"/>
   </start>
   
   
   
   <!--  Assign -->
   
   <decision g="982,240,48,48" name="isAssignee">
      <transition g="47,-26" name="not assigned" to="icf.task.assign">
        <condition expr="#{ISA_ASSIGNEE_NAME==null or ISA_DUEDATE==null}"/>
      </transition>
      <transition name="assigned" to="isImplementation" g="12,-72">
        <condition expr="#{ISA_ASSIGNEE_NAME!=null and ISA_DUEDATE!=null}"/>
      </transition>
   </decision>
   
   <task assignee="#{ISA_OWNER_NAME}" duedate="21 days" g="542,234,186,52" name="icf.task.assign">
      <on event="timeout">
      <timer duedate="14 days"/>
        <event-listener class="sernet.verinice.bpm.Reminder">
          <field name="taskType"><string value="TASK_ASSIGN"/></field>
          <field name="assignee"><object expr="#{ISA_OWNER_NAME}"/></field>
          <field name="uuid"><object expr="#{UUID}"/></field>
        </event-listener>
      </on>
      <transition g="-121,-15" name="icf.trans.assigned" to="java.loadAssignee"/>
   </task>    
   
   <java class="sernet.verinice.bpm.ProzessExecution" g="560,338,150,36" method="loadAssignee" name="java.loadAssignee" var="ISA_ASSIGNEE_NAME">
      <arg><object expr="#{UUID}"/></arg>
      <arg><object expr="rel_control_person-iso"/></arg>
      <transition to="java.loadExecuteDuedate"/>
   </java>  
   
   <java class="sernet.verinice.bpm.isam.IsaControlFlow" g="762,334,202,40" method="loadExecuteDuedate" name="java.loadExecuteDuedate" var="ISA_DUEDATE">
      <arg><object expr="#{UUID}"/></arg>
      <transition to="isAssignee"/>
   </java>      
    
    
    
   <!-- Execute --> 
    
   <task assignee="#{ISA_ASSIGNEE_NAME}" duedate="#{ISA_DUEDATE}" g="914,635,186,52" name="icf.task.execute">
      <on event="timeout">
      <timer duedate="#{ISA_DUEDATE} - 7 days"/>
        <event-listener class="sernet.verinice.bpm.Reminder">
          <field name="taskType"><string value="TASK_EXECUTE"/></field>
          <field name="assignee"><object expr="#{ISA_ASSIGNEE_NAME}"/></field>
          <field name="uuid"><object expr="#{UUID}"/></field>
        </event-listener>
      </on> 
      <transition g="756,602:-202,-5" name="icf.trans.reminderDeadline" to="java.deadlineExecute">
        <timer duedate="#{ISA_DUEDATE}"/>
      </transition>
      <transition g="-80,-21" name="icf.trans.notResposible" to="java.loadComment"/>
      <transition g="-111,-12" name="icf.trans.error" to="java.startQsWorkflow"/>
      <transition g="16,-8" name="icf.trans.check" to="java.loadImplementation"/>
   </task>
  
   <java class="sernet.verinice.bpm.Reminder" g="544,516,178,34" method="sendEmail" name="java.deadlineExecute">
      <arg><object expr="DEADLINE_PASSED"/></arg>
      <arg><object expr="#{ISA_OWNER_NAME}"/></arg>
      <arg><object expr="#{UUID}"/></arg>
      <transition to="icf.task.assign.deadline"/>
   </java> 
   
   <task g="541,416,188,56" assignee="#{ISA_OWNER_NAME}" duedate="21 days" name="icf.task.assign.deadline">
      <transition g="6,-3" name="icf.trans.assigned" to="java.loadAssignee"/>
   </task> 
   
   <java class="sernet.verinice.bpm.isam.IsaControlFlow" g="727,512,178,36" method="startQsWorkflow" name="java.startQsWorkflow">
      <transition g="943,583:" to="icf.task.execute"/>
   </java>
   
   <java class="sernet.verinice.bpm.isam.IsaControlFlow" g="1022,512,196,35" method="loadImplementation" name="java.loadImplementation" var="ISA_IMPLEMENTATION">
      <arg><object expr="#{UUID}"/></arg>
      <transition to="isImplementation"/>
   </java>
   
   <decision g="985,420,48,48" name="isImplementation">
      <transition g="-125,-92" name="not implemented" to="icf.task.execute">
        <condition expr="#{ISA_IMPLEMENTATION=='control_implemented_notedited'}"/>
      </transition>
      <transition g="1222,446;1227,865:-201,-242" name="implemented" to="icf.task.check">
        <condition expr="#{ISA_IMPLEMENTATION!='control_implemented_notedited'}"/>
      </transition>
   </decision> 
   
   
   <!-- not responsible -->
  
   <java class="sernet.verinice.bpm.isam.IsaControlFlow" g="534,643,202,37" method="loadComment" name="java.loadComment" var="ISA_DEADLINE_COMMENT">
      <arg><object expr="#{UUID}"/></arg>
      <transition to="isComment"/>
   </java>
    
   <decision g="395,737,48,48" name="isComment">
      <transition g="-105,25" name="with comment" to="java.notResponsible">
        <condition expr="#{ISA_DEADLINE_COMMENT!=null}"/>
      </transition>
      <transition g="-69,13" name="no comment" to="icf.task.comment">
        <condition expr="#{ISA_DEADLINE_COMMENT==null}"/>
      </transition>
   </decision>
   
   <task assignee="#{ISA_ASSIGNEE_NAME}" duedate="#{ISA_DUEDATE}" g="561,733,147,52" name="icf.task.comment">
      <transition g="8,-6" name="icf.trans.complete" to="java.loadComment"/>
   </task>
   
   <java class="sernet.verinice.bpm.Reminder" g="329,643,182,37" method="sendEmail" name="java.notResponsible">
      <arg><object expr="NOT_RESPONSIBLE"/></arg>
      <arg><object expr="#{ISA_OWNER_NAME}"/></arg>
      <arg><object expr="#{UUID}"/></arg>
      <transition to="icf.task.assign.nr"/>
   </java>
   
   <task g="342,418,147,52" assignee="#{ISA_OWNER_NAME}" duedate="21 days" name="icf.task.assign.nr">
      <transition g="-124,-19" name="icf.trans.assigned" to="java.loadAssignee"/>
   </task>
   
     
   <task assignee="#{ISA_OWNER_NAME}" g="550,837,169,52" name="icf.task.obtainAdvise">
      <transition g="313,865;310,259:34,278" name="icf.trans.reassign" to="icf.task.assign"/>
      <transition g="639,1274:-110,-358" name="icf.trans.finish" to="end"/>
   </task>
   
   
   
   <!-- Audit -->
   
   <task assignee="#{ISA_OWNER_NAME}" g="914,837,186,52" name="icf.task.check">
      <transition g="3,-11" name="icf.trans.audit" to="java.addToAudit"/>
      <transition g="830,878;834,1259:-80,11" name="icf.trans.ok" to="end"/>
      <transition g="-112,-5" name="icf.trans.decline" to="icf.task.execute"/>
      <transition g="-95,-27" name="icf.trans.escalate" to="icf.task.obtainAdvise"/>
   </task>
   
   <java class="sernet.verinice.bpm.isam.IsaControlFlowControlAdder" g="925,936,163,37" method="addControlToAudit" name="java.addToAudit">
      <arg><object expr="#{UUID}"/></arg>
      <arg><object expr="#{UUID_AUDIT}"/></arg>
      <transition to="icf.task.assignAuditor"/>
   </java> 
   
   <task assignee="#{ISA_OWNER_NAME}" g="914,1003,186,52" name="icf.task.assignAuditor">
      <transition g="8,-11" name="icf.trans.wait" to="wait"/>
   </task>
   
   <state g="961,1105,92,35" name="wait">
      <transition to="java.reminderAudit">
      <timer duedate="#{auditDate} - 6 weeks"/>
      </transition>
   </state>

   <java class="sernet.verinice.bpm.Reminder" g="929,1176,156,38" method="sendEmail" name="java.reminderAudit">
      <arg><object expr="TASK_AUDIT"/></arg>
      <arg><object expr="#{ISA_OWNER_NAME}"/></arg>
      <arg><object expr="#{UUID}"/></arg>
      <transition to="end"/>
   </java>
   
   <end g="983,1252,48,48" name="end"/>
   
</process>